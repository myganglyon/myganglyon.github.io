<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Question Bank</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "sans-serif"] },
            colors: {
              zinc: {
                50: "#fafafa",
                100: "#f4f4f5",
                200: "#e4e4e7",
                300: "#d4d4d8",
                400: "#a1a1aa",
                500: "#71717a",
                600: "#52525b",
                700: "#3f3f46",
                800: "#27272a",
                900: "#18181b",
                950: "#09090b",
              },
            },
          },
        },
      };
    </script>
    <!-- Set base styles -->
    <style>
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #a1a1aa;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-track {
        background-color: #f4f4f5;
      }
      .dark ::-webkit-scrollbar-thumb {
        background-color: #52525b;
      }
      .dark ::-webkit-scrollbar-track {
        background-color: #27272a;
      }

      /* Page transition helper */
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }

      /* Modal transition helpers */
      .modal {
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s 0.2s, opacity 0.2s ease;
      }
      .modal.active {
        visibility: visible;
        opacity: 1;
        transition: opacity 0.2s ease;
      }
      .modal-content {
        transform: translateY(100%);
        transition: transform 0.2s ease-out;
      }
      .modal.active .modal-content {
        transform: translateY(0);
      }

      /* Toast notification */
      #toast {
        visibility: hidden;
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
        transition: all 0.3s ease;
      }
      #toast.active {
        visibility: visible;
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    </style>
  </head>
  <body
    class="bg-gray-50 dark:bg-zinc-950 font-sans text-zinc-900 dark:text-zinc-50"
  >
    <!-- App container -->
    <div
      id="app-container"
      class="max-w-lg mx-auto min-h-screen bg-white dark:bg-zinc-900 shadow-lg flex flex-col"
    >
      <!-- ===== PAGE: HOME ===== -->
      <div id="page-home" class="page active flex-grow">
        <header
          class="p-4 flex justify-center items-center border-b border-zinc-200 dark:border-zinc-800 sticky top-0 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm z-10"
        >
          <div class="flex items-center gap-2">
            <h1 class="text-xl font-bold">Ganglyon</h1>
          </div>
        </header>

        <!-- Search Bar -->
        <div class="p-4 border-b border-zinc-200 dark:border-zinc-800">
          <div class="relative">
            <input
              type="text"
              id="search-bar"
              placeholder="Search questions..."
              class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-zinc-300 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            />
            <div
              id="search-icon"
              class="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </div>
          </div>
        </div>

        <!-- Question List -->
        <main
          id="question-list-container"
          class="flex-grow p-4 space-y-4 overflow-y-auto pb-24"
        >
          <!-- Questions will be injected here by JS -->
          <div
            id="empty-state"
            class="hidden text-center text-zinc-500 dark:text-zinc-400 pt-16"
          >
            <svg
              id="empty-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="w-16 h-16 mx-auto mb-4 text-zinc-300 dark:text-zinc-600"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <h3 class="text-lg font-semibold">No Questions Found</h3>
            <p class="text-sm">Try adjusting your search or filters.</p>
          </div>
        </main>

        <!-- Floating Filter Button -->
        <button
          id="open-filter-btn"
          class="fixed bottom-20 right-5 z-20 max-w-lg mx-auto w-14 h-14 rounded-full bg-zinc-900 dark:bg-zinc-50 text-white dark:text-zinc-900 flex items-center justify-center shadow-lg hover:bg-zinc-700 dark:hover:bg-zinc-200 transition-all"
        >
          <svg
            id="filter-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polygon
              points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"
            ></polygon>
          </svg>
        </button>
      </div>

      <!-- ===== PAGE: COLLECTIONS ===== -->
      <div id="page-collections" class="page flex-grow flex-col">
        <header
          class="p-4 flex justify-center items-center border-b border-zinc-200 dark:border-zinc-800 sticky top-0 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm z-10"
        >
          <h1 class="text-xl font-bold">My Collections</h1>
        </header>
        <main
          id="collection-list"
          class="flex-grow p-4 space-y-3 overflow-y-auto pb-24"
        ></main>
        <div
          id="collections-empty-state"
          class="hidden text-center text-zinc-500 dark:text-zinc-400 pt-16 flex-grow"
        >
          <svg
            id="empty-collection-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="w-16 h-16 mx-auto mb-4 text-zinc-300 dark:text-zinc-600"
          >
            <path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"></path>
            <path d="M8 16.25V18a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-1.75"></path>
          </svg>
          <h3 class="text-lg font-semibold">No Collections</h3>
          <p class="text-sm">Bookmark questions to create a new collection.</p>
        </div>
      </div>

      <!-- ===== PAGE: COLLECTION DETAIL ===== -->
      <div id="page-collection-detail" class="page flex-grow flex-col">
        <header
          class="p-4 flex justify-between items-center border-b border-zinc-200 dark:border-zinc-800 sticky top-0 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm z-10"
        >
          <button
            id="back-to-collections-btn"
            class="p-2 -ml-2 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-800"
          >
            <svg
              id="chevron-left-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <h1
            id="collection-detail-title"
            class="text-xl font-bold absolute left-1/2 -translate-x-1/2 truncate max-w-[60%]"
          >
            Collection Name
          </h1>
          <button
            id="delete-collection-btn"
            class="p-2 -mr-2 rounded-md hover:bg-red-100 dark:hover:bg-red-900 text-red-500 dark:text-red-400"
          >
            <svg
              id="trash-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="3 6 5 6 21 6"></polyline>
              <path
                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
              ></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
          </button>
        </header>
        <main
          id="collection-question-list"
          class="flex-grow p-4 space-y-4 overflow-y-auto pb-24"
        ></main>
      </div>

      <!-- ===== PAGE: QUESTION DETAIL ===== -->
      <div id="page-question-detail" class="page flex-grow flex-col">
        <header
          class="p-4 flex items-center gap-3 border-b border-zinc-200 dark:border-zinc-800 sticky top-0 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm z-10"
        >
          <button
            id="back-to-home-btn"
            class="p-2 -ml-2 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-800"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <h1 class="text-xl font-bold">Question</h1>
        </header>

        <main
          id="question-detail-main"
          class="flex-grow p-5 pb-28 space-y-5 overflow-y-auto"
        >
          <div id="qd-text" class="text-2xl leading-snug font-semibold"></div>

          <div id="qd-tags" class="flex flex-wrap gap-2"></div>

          <div>
            <h3
              class="text-sm font-semibold text-zinc-500 dark:text-zinc-400 mb-2"
            >
              Appearances
            </h3>
            <div id="qd-appearances" class="flex flex-wrap gap-2"></div>
          </div>

          <div>
            <h3
              class="text-sm font-semibold text-zinc-500 dark:text-zinc-400 mb-2"
            >
              In Collections
            </h3>
            <div id="qd-collections" class="flex flex-wrap gap-2"></div>
            <div
              id="qd-no-collections"
              class="text-sm text-zinc-500 dark:text-zinc-400 hidden"
            >
              Not in any collection yet.
            </div>
          </div>

          <div class="pt-4">
            <div class="grid grid-cols-2 gap-3">
              <button
                id="qd-bookmark-btn"
                class="w-full bg-zinc-900 dark:bg-zinc-50 text-white dark:text-zinc-900 font-semibold py-3 rounded-lg hover:bg-zinc-700 dark:hover:bg-zinc-200 transition-colors"
              >
                Add To Collection
              </button>
              <button
                id="qd-askai-btn"
                class="w-full border border-zinc-300 dark:border-zinc-700 bg-white dark:bg-zinc-800 text-zinc-900 dark:text-zinc-50 font-semibold py-3 rounded-lg hover:bg-zinc-50 dark:hover:bg-zinc-700 transition-colors"
              >
                Ask AI
              </button>
            </div>
          </div>
        </main>
      </div>

      <!-- ===== Bottom Navigation Bar ===== -->
      <nav
        id="bottom-nav"
        class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto h-16 bg-white dark:bg-zinc-900 border-t border-zinc-200 dark:border-zinc-800 flex justify-around items-center z-30"
      >
        <button
          class="nav-btn flex flex-col items-center justify-center text-zinc-900 dark:text-zinc-50 w-full h-full"
          data-page="home"
        >
          <!-- inside the Home button -->
          <svg
            class="icon-outline w-6 h-6 mb-0.5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9z"></path>
            <path d="M9 22V12h6v10"></path>
          </svg>

          <svg
            class="icon-solid w-6 h-6 mb-0.5 hidden"
            viewBox="0 0 24 24"
            fill="currentColor"
            aria-hidden="true"
          >
            <path
              d="M12 3l9 7v10a2 2 0 0 1-2 2h-5v-7h-4v7H5a2 2 0 0 1-2-2V10l9-7z"
            ></path>
          </svg>

          <span class="text-xs font-medium">Home</span>
        </button>
        <button
          class="nav-btn flex flex-col items-center justify-center text-zinc-500 dark:text-zinc-400 w-full h-full"
          data-page="collections"
        >
          <!-- inside the Collections button -->
          <svg
            class="icon-outline w-6 h-6 mb-0.5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
          </svg>

          <svg
            class="icon-solid w-6 h-6 mb-0.5 hidden"
            viewBox="0 0 24 24"
            fill="currentColor"
            aria-hidden="true"
          >
            <path d="M6 3a2 2 0 0 0-2 2v16l8-5 8 5V5a2 2 0 0 0-2-2H6z"></path>
          </svg>

          <span class="text-xs font-medium">Collections</span>
        </button>
      </nav>
    </div>

    <!-- ===== MODAL: FILTER PANEL ===== -->
    <div
      id="filter-modal"
      class="modal fixed inset-0 bg-black/40 dark:bg-black/60 z-40"
    >
      <div
        id="filter-modal-content"
        class="modal-content fixed bottom-0 left-0 right-0 max-w-lg mx-auto z-50 bg-white dark:bg-zinc-800 rounded-t-2xl p-4 shadow-xl max-h-[80vh] flex flex-col"
      >
        <div
          class="flex justify-between items-center pb-4 border-b border-zinc-200 dark:border-zinc-700"
        >
          <button
            id="filter-reset-btn"
            class="px-3 py-1.5 text-sm font-medium rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-700"
          >
            Reset
          </button>
          <h2 class="text-lg font-semibold">Filters</h2>
          <button
            id="close-filter-btn"
            class="p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-700"
          >
            <svg
              id="close-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>

        <div class="space-y-4 py-4 overflow-y-auto">
          <div>
            <label
              for="filter-subject"
              class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5"
              >Subject</label
            >
            <select
              id="filter-subject"
              data-filter="subject"
              class="filter-select w-full rounded-md border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            ></select>
          </div>
          <div>
            <label
              for="filter-topic"
              class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5"
              >Topic</label
            >
            <select
              id="filter-topic"
              data-filter="topic"
              class="filter-select w-full rounded-md border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            ></select>
          </div>
          <div>
            <label
              for="filter-year"
              class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5"
              >Year</label
            >
            <select
              id="filter-year"
              data-filter="year"
              class="filter-select w-full rounded-md border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            ></select>
          </div>
          <div>
            <label
              for="filter-month"
              class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5"
              >Month</label
            >
            <select
              id="filter-month"
              data-filter="month"
              class="filter-select w-full rounded-md border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            ></select>
          </div>
          <div>
            <label
              for="filter-university"
              class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5"
              >University</label
            >
            <select
              id="filter-university"
              data-filter="university"
              class="filter-select w-full rounded-md border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            ></select>
          </div>
        </div>

        <div class="pt-4 border-t border-zinc-200 dark:border-zinc-700">
          <button
            id="apply-filter-btn"
            class="w-full bg-zinc-900 dark:bg-zinc-50 text-white dark:text-zinc-900 font-semibold py-3 rounded-lg hover:bg-zinc-700 dark:hover:bg-zinc-200 transition-colors"
          >
            Show Results
          </button>
        </div>
      </div>
    </div>

    <!-- ===== MODAL: MANAGE COLLECTIONS ===== -->
    <div
      id="bookmark-modal"
      class="modal fixed inset-0 bg-black/40 dark:bg-black/60 z-40"
    >
      <div
        id="bookmark-modal-content"
        class="modal-content fixed bottom-0 left-0 right-0 max-w-lg mx-auto z-50 bg-white dark:bg-zinc-800 rounded-t-2xl p-4 shadow-xl max-h-[80vh] flex flex-col"
      >
        <div class="flex justify-between items-center pb-2">
          <h2 class="text-lg font-semibold">Manage Collections</h2>
          <button
            id="close-bookmark-btn"
            class="p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-700"
          >
            <svg
              id="close-icon-bookmark"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>

        <div class="space-y-4 py-3 overflow-y-auto">
          <!-- Create New Collection -->
          <div class="flex gap-2" style="padding-left: 2px">
            <input
              type="text"
              id="new-collection-name"
              placeholder="New collection name..."
              class="flex-grow px-3 py-2.5 rounded-lg border border-zinc-300 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            />
            <button
              id="create-collection-btn"
              class="flex-shrink-0 bg-zinc-900 dark:bg-zinc-50 text-white dark:text-zinc-900 font-semibold px-4 py-2 rounded-lg hover:bg-zinc-700 dark:hover:bg-zinc-200 transition-colors"
            >
              Create
            </button>
          </div>
          <div
            id="new-collection-error"
            class="text-red-500 text-sm hidden"
          ></div>

          <!-- Divider -->
          <div class="relative flex py-2 items-center">
            <div
              class="flex-grow border-t border-zinc-200 dark:border-zinc-700"
            ></div>
            <span
              class="flex-shrink mx-4 text-xs text-zinc-400 dark:text-zinc-500"
              >Select collections</span
            >
            <div
              class="flex-grow border-t border-zinc-200 dark:border-zinc-700"
            ></div>
          </div>

          <!-- Existing Collections List (checkboxes) -->
          <div id="existing-collections-list" class="space-y-1"></div>
          <div
            id="existing-collections-empty"
            class="text-center text-zinc-500 dark:text-zinc-400 py-3 hidden"
          >
            <p>No existing collections. Create one above.</p>
          </div>
        </div>

        <div class="pt-3 border-t border-zinc-200 dark:border-zinc-700">
          <button
            id="bookmark-save-btn"
            class="w-full bg-zinc-900 dark:bg-zinc-50 text-white dark:text-zinc-900 font-semibold py-3 rounded-lg hover:bg-zinc-700 dark:hover:bg-zinc-200 transition-colors"
          >
            Save
          </button>
        </div>
      </div>
    </div>

    <!-- ===== TOAST NOTIFICATION ===== -->
    <div
      id="toast"
      class="fixed bottom-24 left-1/2 -translate-x-1/2 z-50 bg-zinc-900 dark:bg-zinc-50 text-white dark:text-zinc-900 px-4 py-2.5 rounded-full shadow-lg text-sm font-medium"
    >
      <span id="toast-message"></span>
    </div>

    <!-- =========== JAVASCRIPT =========== -->
    <script src="database.js"></script>
    <script type="module">
      // Your provided database

      // --- ICON SVG Definitions ---
      const ICONS = {
        bookmark: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>`,
        bookmarkFilled: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>`,
        folder: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-zinc-500 dark:text-zinc-400"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`,
        chevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`,
      };

      const MONTH_ABBR = {
        January: "Jan",
        February: "Feb",
        March: "Mar",
        April: "Apr",
        May: "May",
        June: "Jun",
        July: "Jul",
        August: "Aug",
        September: "Sep",
        October: "Oct",
        November: "Nov",
        December: "Dec",
      };

      // --- Main Application ---
      document.addEventListener("DOMContentLoaded", () => {
        // --- State ---
        const state = {
          allQuestions: [],
          filteredQuestions: [],
          collections: {}, // { "collectionName": [id1, id2] }
          currentFilters: {
            subject: null,
            topic: null,
            year: null,
            month: null,
            university: null,
          },
          currentPage: "home",
          currentQuestionId: null, // for detail page
          questionToBookmark: null, // for modal
          tempSelectedCollections: new Set(), // live selection in modal
          toastTimer: null,
        };

        // --- DOM Elements ---
        const dom = {
          pages: document.querySelectorAll(".page"),
          homePage: document.getElementById("page-home"),
          collectionsPage: document.getElementById("page-collections"),
          collectionDetailPage: document.getElementById(
            "page-collection-detail"
          ),
          questionDetailPage: document.getElementById("page-question-detail"),

          questionListContainer: document.getElementById(
            "question-list-container"
          ),
          emptyState: document.getElementById("empty-state"),
          searchBar: document.getElementById("search-bar"),

          // Bottom Nav
          navButtons: document.querySelectorAll(".nav-btn"),

          // Filter Modal
          filterModal: document.getElementById("filter-modal"),
          openFilterBtn: document.getElementById("open-filter-btn"),
          closeFilterBtn: document.getElementById("close-filter-btn"),
          applyFilterBtn: document.getElementById("apply-filter-btn"),
          filterResetBtn: document.getElementById("filter-reset-btn"),
          filterSelects: document.querySelectorAll(".filter-select"),

          // Collections Page
          collectionList: document.getElementById("collection-list"),
          collectionsEmptyState: document.getElementById(
            "collections-empty-state"
          ),

          // Collection Detail Page
          backToCollectionsBtn: document.getElementById(
            "back-to-collections-btn"
          ),
          deleteCollectionBtn: document.getElementById("delete-collection-btn"),
          collectionDetailTitle: document.getElementById(
            "collection-detail-title"
          ),
          collectionQuestionList: document.getElementById(
            "collection-question-list"
          ),

          // Question Detail Page
          backToHomeBtn: document.getElementById("back-to-home-btn"),
          qdText: document.getElementById("qd-text"),
          qdTags: document.getElementById("qd-tags"),
          qdAppearances: document.getElementById("qd-appearances"),
          qdCollections: document.getElementById("qd-collections"),
          qdNoCollections: document.getElementById("qd-no-collections"),
          qdBookmarkBtn: document.getElementById("qd-bookmark-btn"),
          qdAskAiBtn: document.getElementById("qd-askai-btn"),

          // Bookmark Modal
          bookmarkModal: document.getElementById("bookmark-modal"),
          closeBookmarkBtn: document.getElementById("close-bookmark-btn"),
          newCollectionName: document.getElementById("new-collection-name"),
          newCollectionError: document.getElementById("new-collection-error"),
          createCollectionBtn: document.getElementById("create-collection-btn"),
          existingCollectionsList: document.getElementById(
            "existing-collections-list"
          ),
          existingCollectionsEmpty: document.getElementById(
            "existing-collections-empty"
          ),
          bookmarkSaveBtn: document.getElementById("bookmark-save-btn"),

          // Toast
          toast: document.getElementById("toast"),
          toastMessage: document.getElementById("toast-message"),
        };

        // --- Initialization ---
        function init() {
          loadData();
          loadCollections();
          bindNavListeners();
          bindFilterModalListeners();
          bindBookmarkModalListeners();
          bindSearchListener();
          bindCollectionDetailListeners();
          bindQuestionDetailListeners();

          populateFilterDropdowns();
          applyFiltersAndSearch();
          renderPage(state.currentPage);

          // Respect system dark mode
          if (
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches
          ) {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        }

        // --- Data Loading ---
        function loadData() {
          state.allQuestions = DB;
          state.filteredQuestions = [...state.allQuestions];
        }
        function loadCollections() {
          state.collections =
            JSON.parse(localStorage.getItem("qbank_collections")) || {};
        }
        function saveCollections() {
          localStorage.setItem(
            "qbank_collections",
            JSON.stringify(state.collections)
          );
        }

        // --- Page Navigation ---
        function renderPage(pageId) {
          state.currentPage = pageId;
          dom.pages.forEach((page) =>
            page.classList.toggle("active", page.id === `page-${pageId}`)
          );

          dom.navButtons.forEach((btn) => {
            const isActive = btn.dataset.page === pageId;
            btn.classList.toggle("text-zinc-900", isActive);
            btn.classList.toggle("dark:text-zinc-50", isActive);
            btn.classList.toggle("text-zinc-500", !isActive);
            btn.classList.toggle("dark:text-zinc-400", !isActive);
          });

          dom.navButtons.forEach((btn) => {
            const isActive = btn.dataset.page === pageId;
            btn
              .querySelector(".icon-outline")
              ?.classList.toggle("hidden", isActive);
            btn
              .querySelector(".icon-solid")
              ?.classList.toggle("hidden", !isActive);
          });

          if (pageId === "home") {
            applyFiltersAndSearch();
          } else if (pageId === "collections") {
            renderCollectionsPage();
          } else if (
            pageId === "question-detail" &&
            state.currentQuestionId != null
          ) {
            renderQuestionDetailPage(state.currentQuestionId);
          }
        }

        function bindNavListeners() {
          dom.navButtons.forEach((btn) => {
            btn.addEventListener("click", () => renderPage(btn.dataset.page));
          });
        }

        // --- Helpers ---
        function buildAppearancesHTML(q) {
          const grouped = {};
          const monthKeys = Object.keys(MONTH_ABBR);
          q.appearances.forEach((a) => {
            const monthName = a.month;
            const monthAbbr = MONTH_ABBR[monthName] || monthName;
            const monthIndex = monthKeys.indexOf(monthName);
            const year = parseInt(a.year.toString());
            const dateStr = `${monthAbbr} '${year.toString().slice(-2)}`;
            if (!grouped[a.university]) grouped[a.university] = [];
            grouped[a.university].push({ year, monthIndex, dateStr });
          });

          return Object.entries(grouped)
            .map(([university, dates]) => {
              dates.sort((a, b) =>
                a.year !== b.year
                  ? b.year - a.year
                  : a.monthIndex - b.monthIndex
              );
              const dateStrings = dates.map((d) => d.dateStr).join(", ");
              return `<span class="inline-block bg-zinc-100 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2.5 py-1 rounded-full text-xs font-medium">${university} ${dateStrings}</span>`;
            })
            .join("");
        }

        function questionCollections(id) {
          // returns array of collection names containing the question
          return Object.entries(state.collections)
            .filter(([, ids]) => ids.includes(id))
            .map(([name]) => name);
        }

        // --- Question Rendering (Cards) ---
        function renderQuestionList(questions, container) {
          container.innerHTML = "";

          if (questions.length === 0) {
            if (container === dom.questionListContainer)
              dom.emptyState.classList.remove("hidden");
            else
              container.innerHTML = `
              <div class="text-center text-zinc-500 dark:text-zinc-400 pt-16">
                <h3 class="text-lg font-semibold">Collection is Empty</h3>
                <p class="text-sm">You can remove questions from a collection here.</p>
              </div>`;
            return;
          }
          if (container === dom.questionListContainer)
            dom.emptyState.classList.add("hidden");

          const fragment = document.createDocumentFragment();
          const allBookmarkedIds = Object.values(state.collections).flat();

          questions.forEach((q) => {
            const isBookmarked = allBookmarkedIds.includes(q.id);
            const card = document.createElement("div");
            card.className =
              "bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg shadow-sm p-4 relative cursor-pointer hover:bg-zinc-50 dark:hover:bg-zinc-700/40 transition-colors";

            const appearancesHTML = buildAppearancesHTML(q);

            card.innerHTML = `
              <button class="bookmark-btn absolute top-3 right-3 p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-700 ${
                isBookmarked
                  ? "text-zinc-900 dark:text-zinc-100"
                  : "text-zinc-400 dark:text-zinc-500"
              }" data-id="${q.id}">
                ${isBookmarked ? ICONS.bookmarkFilled : ICONS.bookmark}
              </button>
              <p class="text-base font-medium text-zinc-900 dark:text-white pr-10">${
                q.text
              }</p>
              <div class="mt-3 flex flex-wrap gap-2">
                <span class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 px-2.5 py-1 rounded-full text-xs font-medium">${
                  q.subject
                }</span>
                <span class="inline-block bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-200 px-2.5 py-1 rounded-full text-xs font-medium">${
                  q.topic
                }</span>
              </div>
              <div class="mt-3 flex flex-wrap gap-2">
                ${appearancesHTML}
              </div>
            `;

            // Open detail page on card click
            card.addEventListener("click", () => {
              state.currentQuestionId = q.id;
              renderPage("question-detail");
            });

            // Bookmark button (stop bubbling)
            card
              .querySelector(".bookmark-btn")
              .addEventListener("click", (e) => {
                e.stopPropagation();
                openManageCollectionsModal(q.id);
              });

            fragment.appendChild(card);
          });

          container.appendChild(fragment);
        }

        // --- Search ---
        function bindSearchListener() {
          dom.searchBar.addEventListener("input", () =>
            applyFiltersAndSearch()
          );
        }

        // --- Filtering Logic (Dependent) ---
        function bindFilterModalListeners() {
          dom.openFilterBtn.addEventListener("click", () => {
            populateFilterDropdowns();
            dom.filterModal.classList.add("active");
          });
          dom.closeFilterBtn.addEventListener("click", () =>
            dom.filterModal.classList.remove("active")
          );
          dom.applyFilterBtn.addEventListener("click", () => {
            applyFiltersAndSearch();
            dom.filterModal.classList.remove("active");
          });
          dom.filterModal.addEventListener("click", (e) => {
            if (e.target === dom.filterModal)
              dom.filterModal.classList.remove("active");
          });
          dom.filterResetBtn.addEventListener("click", resetFilters);

          dom.filterSelects.forEach((select) => {
            select.addEventListener("change", () => {
              state.currentFilters[select.dataset.filter] =
                select.value || null;
              populateFilterDropdowns();
            });
          });
        }

        function resetFilters() {
          state.currentFilters = {
            subject: null,
            topic: null,
            year: null,
            month: null,
            university: null,
          };
          populateFilterDropdowns();
          applyFiltersAndSearch();
        }

        function getPotentiallyAvailableQuestions(filterToOmit) {
          let questions = state.allQuestions;
          for (const key in state.currentFilters) {
            if (key === filterToOmit || !state.currentFilters[key]) continue;
            const filterValue = state.currentFilters[key];
            if (key === "subject" || key === "topic") {
              questions = questions.filter((q) => q[key] === filterValue);
            } else {
              questions = questions.filter((q) =>
                q.appearances.some((a) => a[key].toString() === filterValue)
              );
            }
          }
          return questions;
        }

        function populateFilterDropdowns() {
          dom.filterSelects.forEach((select) => {
            const filterKey = select.dataset.filter;
            const availableQuestions =
              getPotentiallyAvailableQuestions(filterKey);

            let options;
            if (filterKey === "subject" || filterKey === "topic") {
              options = [
                ...new Set(availableQuestions.map((q) => q[filterKey])),
              ];
            } else {
              options = [
                ...new Set(
                  availableQuestions.flatMap((q) =>
                    q.appearances.map((a) => a[filterKey].toString())
                  )
                ),
              ];
            }
            options.sort();
            if (filterKey === "year") options.sort((a, b) => b - a);

            renderSelectOptions(
              select,
              options,
              state.currentFilters[filterKey],
              `All ${filterKey}s`
            );
          });
        }

        function renderSelectOptions(
          selectEl,
          options,
          selectedValue,
          placeholder
        ) {
          const currentValue = selectedValue || "";
          selectEl.innerHTML = `<option value="">${placeholder}</option>`;
          options.forEach((option) => {
            const isSelected = option === currentValue;
            selectEl.innerHTML += `<option value="${option}" ${
              isSelected ? "selected" : ""
            }>${option}</option>`;
          });
        }

        function applyFiltersAndSearch() {
          let questions = state.allQuestions;
          for (const key in state.currentFilters) {
            const filterValue = state.currentFilters[key];
            if (!filterValue) continue;

            if (key === "subject" || key === "topic") {
              questions = questions.filter((q) => q[key] === filterValue);
            } else {
              questions = questions.filter((q) =>
                q.appearances.some((a) => a[key].toString() === filterValue)
              );
            }
          }

          const searchTerm = dom.searchBar.value.toLowerCase().trim();
          if (searchTerm) {
            questions = questions.filter(
              (q) =>
                q.text.toLowerCase().includes(searchTerm) ||
                q.subject.toLowerCase().includes(searchTerm) ||
                q.topic.toLowerCase().includes(searchTerm)
            );
          }

          state.filteredQuestions = questions;
          renderQuestionList(
            state.filteredQuestions,
            dom.questionListContainer
          );
        }

        // --- Bookmark & Collection Logic (Multi-collection) ---
        function bindBookmarkModalListeners() {
          dom.closeBookmarkBtn.addEventListener("click", () =>
            dom.bookmarkModal.classList.remove("active")
          );
          dom.bookmarkModal.addEventListener("click", (e) => {
            if (e.target === dom.bookmarkModal)
              dom.bookmarkModal.classList.remove("active");
          });

          dom.createCollectionBtn.addEventListener("click", () => {
            const name = dom.newCollectionName.value.trim();
            dom.newCollectionError.classList.add("hidden");

            if (!name) {
              dom.newCollectionError.textContent = "Please enter a name.";
              dom.newCollectionError.classList.remove("hidden");
              return;
            }
            if (state.collections[name]) {
              dom.newCollectionError.textContent =
                "A collection with this name already exists.";
              dom.newCollectionError.classList.remove("hidden");
              return;
            }

            // Create empty collection and auto-select it for this question in the temp set
            state.collections[name] = [];
            state.tempSelectedCollections.add(name);
            dom.newCollectionName.value = "";
            renderExistingCollectionsChecklist(); // re-render with new one checked
          });

          dom.newCollectionName.addEventListener("keyup", (e) => {
            if (e.key === "Enter") dom.createCollectionBtn.click();
          });

          dom.bookmarkSaveBtn.addEventListener("click", saveBookmarkSelections);
        }

        function openManageCollectionsModal(questionId) {
          state.questionToBookmark = questionId;
          // initialize temp selections from real membership
          state.tempSelectedCollections = new Set(
            questionCollections(questionId)
          );
          renderExistingCollectionsChecklist();
          dom.bookmarkModal.classList.add("active");
        }

        function renderExistingCollectionsChecklist() {
          const collectionNames = Object.keys(state.collections).sort((a, b) =>
            a.localeCompare(b)
          );
          if (collectionNames.length === 0) {
            dom.existingCollectionsList.innerHTML = "";
            dom.existingCollectionsEmpty.classList.remove("hidden");
            return;
          }
          dom.existingCollectionsEmpty.classList.add("hidden");

          dom.existingCollectionsList.innerHTML = collectionNames
            .map((name) => {
              const checked = state.tempSelectedCollections.has(name)
                ? "checked"
                : "";
              return `
                <label class="flex items-center gap-3 p-2.5 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-700 cursor-pointer">
                  <input type="checkbox" class="collection-checkbox accent-black dark:accent-white" data-name="${name}" ${checked} />
                  <div class="flex items-center gap-3">
                    ${ICONS.folder}
                    <span class="font-medium">${name}</span>
                  </div>
                </label>
              `;
            })
            .join("");

          // wire checkboxes to temp set
          dom.existingCollectionsList
            .querySelectorAll(".collection-checkbox")
            .forEach((cb) => {
              cb.addEventListener("change", () => {
                const name = cb.dataset.name;
                if (cb.checked) state.tempSelectedCollections.add(name);
                else state.tempSelectedCollections.delete(name);
              });
            });
        }

        function saveBookmarkSelections() {
          const qid = state.questionToBookmark;
          if (qid == null) return;

          // For each collection, ensure membership matches temp selection
          const selected = new Set(state.tempSelectedCollections);

          // Add membership
          selected.forEach((name) => {
            if (!state.collections[name]) state.collections[name] = [];
            if (!state.collections[name].includes(qid))
              state.collections[name].push(qid);
          });

          // Remove membership from collections not selected
          Object.keys(state.collections).forEach((name) => {
            const arr = state.collections[name];
            const idx = arr.indexOf(qid);
            if (!selected.has(name) && idx !== -1) {
              arr.splice(idx, 1);
              // keep empty collections (so users can reuse them)
            }
          });

          saveCollections();
          dom.bookmarkModal.classList.remove("active");
          showToast("Collections updated");
          state.questionToBookmark = null;

          refreshCurrentList();
        }

        function refreshCurrentList() {
          if (state.currentPage === "home") {
            renderQuestionList(
              state.filteredQuestions,
              dom.questionListContainer
            );
          } else if (state.currentPage === "collection-detail") {
            const collectionName = dom.collectionDetailTitle.textContent;
            if (state.collections[collectionName]) {
              renderCollectionDetailPage(collectionName);
            } else {
              renderPage("collections");
            }
          } else if (
            state.currentPage === "question-detail" &&
            state.currentQuestionId != null
          ) {
            renderQuestionDetailPage(state.currentQuestionId);
          }
        }

        // --- Collections Page ---
        function renderCollectionsPage() {
          const collectionNames = Object.keys(state.collections);
          if (collectionNames.length === 0) {
            dom.collectionList.innerHTML = "";
            dom.collectionsEmptyState.classList.remove("hidden");
            return;
          }

          dom.collectionsEmptyState.classList.add("hidden");
          dom.collectionList.innerHTML = collectionNames
            .map((name) => {
              const count = state.collections[name].length;
              return `
                <button class="view-collection-btn w-full flex justify-between items-center bg-white dark:bg-zinc-800 p-4 rounded-lg border border-zinc-200 dark:border-zinc-700 shadow-sm hover:bg-zinc-50 dark:hover:bg-zinc-700" data-name="${name}">
                  <div class="flex items-center gap-3">
                    ${ICONS.folder}
                    <div>
                      <h3 class="font-semibold text-left">${name}</h3>
                      <p class="text-sm text-zinc-500 dark:text-zinc-400">${count} question${
                count !== 1 ? "s" : ""
              }</p>
                    </div>
                  </div>
                  ${ICONS.chevronRight}
                </button>
              `;
            })
            .join("");

          document.querySelectorAll(".view-collection-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              renderCollectionDetailPage(btn.dataset.name);
              renderPage("collection-detail");
            });
          });
        }

        // --- Collection Detail Page ---
        function bindCollectionDetailListeners() {
          dom.backToCollectionsBtn.addEventListener("click", () =>
            renderPage("collections")
          );
          dom.deleteCollectionBtn.addEventListener("click", () => {
            const collectionName = dom.collectionDetailTitle.textContent;
            if (collectionName && state.collections[collectionName]) {
              delete state.collections[collectionName];
              saveCollections();
              showToast(`Collection "${collectionName}" deleted`);
              renderPage("collections");
            }
          });
        }

        function renderCollectionDetailPage(collectionName) {
          dom.collectionDetailTitle.textContent = collectionName;
          const questionIds = state.collections[collectionName] || [];
          const questions = state.allQuestions.filter((q) =>
            questionIds.includes(q.id)
          );
          renderQuestionList(questions, dom.collectionQuestionList);
        }

        // --- Question Detail Page ---
        function bindQuestionDetailListeners() {
          dom.backToHomeBtn.addEventListener("click", () => renderPage("home"));
          dom.qdBookmarkBtn.addEventListener("click", () => {
            if (state.currentQuestionId != null)
              openManageCollectionsModal(state.currentQuestionId);
          });
          dom.qdAskAiBtn.addEventListener("click", () => {
            showToast("Keep supporting this app for this future feature.");
          });
        }

        function renderQuestionDetailPage(id) {
          const q = state.allQuestions.find((x) => x.id === id);
          if (!q) {
            renderPage("home");
            return;
          }

          dom.qdText.textContent = q.text;

          dom.qdTags.innerHTML = `
            <span class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 px-2.5 py-1 rounded-full text-xs font-medium">${q.subject}</span>
            <span class="inline-block bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-200 px-2.5 py-1 rounded-full text-xs font-medium">${q.topic}</span>
          `;

          dom.qdAppearances.innerHTML = buildAppearancesHTML(q);

          const cols = questionCollections(id);
          if (cols.length === 0) {
            dom.qdCollections.innerHTML = "";
            dom.qdNoCollections.classList.remove("hidden");
          } else {
            dom.qdNoCollections.classList.add("hidden");
            dom.qdCollections.innerHTML = cols
              .sort((a, b) => a.localeCompare(b))
              .map(
                (name) =>
                  `<span class="inline-block bg-zinc-100 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2.5 py-1 rounded-full text-xs font-medium">${name}</span>`
              )
              .join("");
          }
        }

        // --- Toast ---
        function showToast(message) {
          if (state.toastTimer) clearTimeout(state.toastTimer);
          dom.toastMessage.textContent = message;
          dom.toast.classList.add("active");
          state.toastTimer = setTimeout(() => {
            dom.toast.classList.remove("active");
            state.toastTimer = null;
          }, 2000);
        }

        // --- Start the app ---
        init();
      });
    </script>
  </body>
</html>
