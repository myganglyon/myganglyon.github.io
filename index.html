<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Question Bank</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class", // or 'media'
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
            colors: {
              // Using zinc as a base for the shadcn monochrome feel
              zinc: {
                50: "#fafafa",
                100: "#f4f4f5",
                200: "#e4e4e7",
                300: "#d4d4d8",
                400: "#a1a1aa",
                500: "#71717a",
                600: "#52525b",
                700: "#3f3f46",
                800: "#27272a",
                900: "#18181b",
                950: "#09090b",
              },
            },
          },
        },
      };
    </script>
    <!-- Set base styles -->
    <style>
      body {
        /* Basic font smoothing */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      /* Simple scrollbar for a cleaner look */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #a1a1aa; /* zinc-400 */
        border-radius: 3px;
      }
      ::-webkit-scrollbar-track {
        background-color: #f4f4f5; /* zinc-100 */
      }
      .dark ::-webkit-scrollbar-thumb {
        background-color: #52525b; /* zinc-600 */
      }
      .dark ::-webkit-scrollbar-track {
        background-color: #27272a; /* zinc-800 */
      }

      /* Page transition helper */
      .page {
        display: none; /* Hidden by default */
      }
      .page.active {
        display: block; /* Shown when active */
      }

      /* Modal transition helpers */
      .modal {
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s 0.2s, opacity 0.2s ease;
      }
      .modal.active {
        visibility: visible;
        opacity: 1;
        transition: opacity 0.2s ease;
      }
      .modal-content {
        transform: translateY(100%);
        transition: transform 0.2s ease-out;
      }
      .modal.active .modal-content {
        transform: translateY(0);
      }

      /* Toast notification */
      #toast {
        visibility: hidden;
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
        transition: all 0.3s ease;
      }
      #toast.active {
        visibility: visible;
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    </style>
  </head>
  <body
    class="bg-gray-50 dark:bg-zinc-950 font-sans text-zinc-900 dark:text-zinc-50"
  >
    <!-- 
      App container: Simulates a mobile app frame.
      On desktop, it's a centered column. On mobile, it's full-width.
    -->
    <div
      id="app-container"
      class="max-w-lg mx-auto min-h-screen bg-white dark:bg-zinc-900 shadow-lg flex flex-col"
    >
      <!-- ===== PAGE: HOME ===== -->
      <div id="page-home" class="page active flex-grow">
        <header
          class="p-4 flex justify-center items-center border-b border-zinc-200 dark:border-zinc-800 sticky top-0 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm z-10"
        >
          <!-- App Logo -->
          <div class="flex items-center gap-2">
            <h1 class="text-xl font-bold">Ganglyon</h1>
          </div>
        </header>

        <!-- Search Bar -->
        <div class="p-4 border-b border-zinc-200 dark:border-zinc-800">
          <div class="relative">
            <input
              type="text"
              id="search-bar"
              placeholder="Search questions..."
              class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-zinc-300 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            />
            <div
              id="search-icon"
              class="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400"
            >
              <!-- Search Icon -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </div>
          </div>
        </div>

        <!-- Question List -->
        <main
          id="question-list-container"
          class="flex-grow p-4 space-y-4 overflow-y-auto pb-24"
        >
          <!-- Questions will be injected here by JS -->
          <!-- Empty State -->
          <div
            id="empty-state"
            class="hidden text-center text-zinc-500 dark:text-zinc-400 pt-16"
          >
            <svg
              id="empty-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="w-16 h-16 mx-auto mb-4 text-zinc-300 dark:text-zinc-600"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <h3 class="text-lg font-semibold">No Questions Found</h3>
            <p class="text-sm">Try adjusting your search or filters.</p>
          </div>
        </main>

        <!-- Floating Filter Button -->
        <button
          id="open-filter-btn"
          class="fixed bottom-20 right-5 z-20 max-w-lg mx-auto w-14 h-14 rounded-full bg-zinc-900 dark:bg-zinc-50 text-white dark:text-zinc-900 flex items-center justify-center shadow-lg hover:bg-zinc-700 dark:hover:bg-zinc-200 transition-all"
        >
          <!-- Filter Icon -->
          <svg
            id="filter-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polygon
              points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"
            ></polygon>
          </svg>
        </button>
      </div>

      <!-- ===== PAGE: COLLECTIONS ===== -->
      <div id="page-collections" class="page flex-grow flex-col">
        <header
          class="p-4 flex justify-center items-center border-b border-zinc-200 dark:border-zinc-800 sticky top-0 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm z-10"
        >
          <h1 class="text-xl font-bold">My Collections</h1>
        </header>
        <main
          id="collection-list"
          class="flex-grow p-4 space-y-3 overflow-y-auto pb-24"
        >
          <!-- Collection items will be injected here -->
        </main>
        <!-- Empty state for collections -->
        <div
          id="collections-empty-state"
          class="hidden text-center text-zinc-500 dark:text-zinc-400 pt-16 flex-grow"
        >
          <svg
            id="empty-collection-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="w-16 h-16 mx-auto mb-4 text-zinc-300 dark:text-zinc-600"
          >
            <path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"></path>
            <path d="M8 16.25V18a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-1.75"></path>
          </svg>
          <h3 class="text-lg font-semibold">No Collections</h3>
          <p class="text-sm">Bookmark questions to create a new collection.</p>
        </div>
      </div>

      <!-- ===== PAGE: COLLECTION DETAIL ===== -->
      <div id="page-collection-detail" class="page flex-grow flex-col">
        <header
          class="p-4 flex justify-between items-center border-b border-zinc-200 dark:border-zinc-800 sticky top-0 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm z-10"
        >
          <button
            id="back-to-collections-btn"
            class="p-2 -ml-2 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-800"
          >
            <!-- Chevron Left Icon -->
            <svg
              id="chevron-left-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <h1
            id="collection-detail-title"
            class="text-xl font-bold absolute left-1/2 -translate-x-1/2 truncate max-w-[60%]"
          >
            Collection Name
          </h1>
          <button
            id="delete-collection-btn"
            class="p-2 -mr-2 rounded-md hover:bg-red-100 dark:hover:bg-red-900 text-red-500 dark:text-red-400"
          >
            <!-- Trash Icon -->
            <svg
              id="trash-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="3 6 5 6 21 6"></polyline>
              <path
                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
              ></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
          </button>
        </header>
        <main
          id="collection-question-list"
          class="flex-grow p-4 space-y-4 overflow-y-auto pb-24"
        >
          <!-- Questions for this collection will be injected here -->
        </main>
      </div>

      <!-- ===== Bottom Navigation Bar ===== -->
      <nav
        id="bottom-nav"
        class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto h-16 bg-white dark:bg-zinc-900 border-t border-zinc-200 dark:border-zinc-800 flex justify-around items-center z-30"
      >
        <button
          class="nav-btn flex flex-col items-center justify-center text-zinc-900 dark:text-zinc-50 w-full h-full"
          data-page="home"
        >
          <!-- Home Icon -->
          <svg
            id="home-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="w-6 h-6 mb-0.5"
          >
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          <span class="text-xs font-medium">Home</span>
        </button>
        <button
          class="nav-btn flex flex-col items-center justify-center text-zinc-500 dark:text-zinc-400 w-full h-full"
          data-page="collections"
        >
          <!-- Collections (Bookmark) Icon -->
          <svg
            id="bookmark-nav-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="w-6 h-6 mb-0.5"
          >
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
          </svg>
          <span class="text-xs font-medium">Collections</span>
        </button>
      </nav>
    </div>

    <!-- ===== MODAL: FILTER PANEL ===== -->
    <div
      id="filter-modal"
      class="modal fixed inset-0 bg-black/40 dark:bg-black/60 z-40"
    >
      <div
        id="filter-modal-content"
        class="modal-content fixed bottom-0 left-0 right-0 max-w-lg mx-auto z-50 bg-white dark:bg-zinc-800 rounded-t-2xl p-4 shadow-xl max-h-[80vh] flex flex-col"
      >
        <!-- Modal Header -->
        <div
          class="flex justify-between items-center pb-4 border-b border-zinc-200 dark:border-zinc-700"
        >
          <button
            id="filter-reset-btn"
            class="px-3 py-1.5 text-sm font-medium rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-700"
          >
            Reset
          </button>
          <h2 class="text-lg font-semibold">Filters</h2>
          <button
            id="close-filter-btn"
            class="p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-700"
          >
            <!-- Close Icon -->
            <svg
              id="close-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <!-- Modal Body -->
        <div class="space-y-4 py-4 overflow-y-auto">
          <div>
            <label
              for="filter-subject"
              class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5"
              >Subject</label
            >
            <select
              id="filter-subject"
              data-filter="subject"
              class="filter-select w-full rounded-md border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            >
              <!-- Options injected by JS -->
            </select>
          </div>
          <div>
            <label
              for="filter-topic"
              class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5"
              >Topic</label
            >
            <select
              id="filter-topic"
              data-filter="topic"
              class="filter-select w-full rounded-md border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            >
              <!-- Options injected by JS -->
            </select>
          </div>
          <div>
            <label
              for="filter-year"
              class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5"
              >Year</label
            >
            <select
              id="filter-year"
              data-filter="year"
              class="filter-select w-full rounded-md border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            >
              <!-- Options injected by JS -->
            </select>
          </div>
          <div>
            <label
              for="filter-month"
              class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5"
              >Month</label
            >
            <select
              id="filter-month"
              data-filter="month"
              class="filter-select w-full rounded-md border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            >
              <!-- Options injected by JS -->
            </select>
          </div>
          <div>
            <label
              for="filter-university"
              class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5"
              >University</label
            >
            <select
              id="filter-university"
              data-filter="university"
              class="filter-select w-full rounded-md border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            >
              <!-- Options injected by JS -->
            </select>
          </div>
        </div>
        <!-- Modal Footer -->
        <div class="pt-4 border-t border-zinc-200 dark:border-zinc-700">
          <button
            id="apply-filter-btn"
            class="w-full bg-zinc-900 dark:bg-zinc-50 text-white dark:text-zinc-900 font-semibold py-3 rounded-lg hover:bg-zinc-700 dark:hover:bg-zinc-200 transition-colors"
          >
            Show Results
          </button>
        </div>
      </div>
    </div>

    <!-- ===== MODAL: BOOKMARK/COLLECTION ===== -->
    <div
      id="bookmark-modal"
      class="modal fixed inset-0 bg-black/40 dark:bg-black/60 z-40"
    >
      <div
        id="bookmark-modal-content"
        class="modal-content fixed bottom-0 left-0 right-0 max-w-lg mx-auto z-50 bg-white dark:bg-zinc-800 rounded-t-2xl p-4 shadow-xl max-h-[80vh] flex flex-col"
      >
        <!-- Modal Header -->
        <div class="flex justify-between items-center pb-4">
          <h2 class="text-lg font-semibold">Save to Collection</h2>
          <button
            id="close-bookmark-btn"
            class="p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-700"
          >
            <!-- Close Icon -->
            <svg
              id="close-icon-bookmark"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <!-- Modal Body -->
        <div class="space-y-4 py-4 overflow-y-auto">
          <!-- Create New Collection -->
          <div class="flex gap-2">
            <input
              type="text"
              id="new-collection-name"
              placeholder="New collection name..."
              class="flex-grow px-3 py-2.5 rounded-lg border border-zinc-300 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
            />
            <button
              id="create-collection-btn"
              class="flex-shrink-0 bg-zinc-900 dark:bg-zinc-50 text-white dark:text-zinc-900 font-semibold px-4 py-2 rounded-lg hover:bg-zinc-700 dark:hover:bg-zinc-200 transition-colors"
            >
              Create
            </button>
          </div>
          <div
            id="new-collection-error"
            class="text-red-500 text-sm hidden"
          ></div>

          <!-- Horizontal divider -->
          <div class="relative flex py-2 items-center">
            <div
              class="flex-grow border-t border-zinc-200 dark:border-zinc-700"
            ></div>
            <span
              class="flex-shrink mx-4 text-xs text-zinc-400 dark:text-zinc-500"
              >OR</span
            >
            <div
              class="flex-grow border-t border-zinc-200 dark:border-zinc-700"
            ></div>
          </div>

          <!-- Existing Collections List -->
          <div id="existing-collections-list" class="space-y-2">
            <!-- Collections injected by JS -->
          </div>
          <div
            id="existing-collections-empty"
            class="text-center text-zinc-500 dark:text-zinc-400 py-4 hidden"
          >
            <p>No existing collections. Create one above.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== TOAST NOTIFICATION ===== -->
    <div
      id="toast"
      class="fixed bottom-24 left-1/2 -translate-x-1/2 z-50 bg-zinc-900 dark:bg-zinc-50 text-white dark:text-zinc-900 px-4 py-2.5 rounded-full shadow-lg text-sm font-medium"
    >
      <span id="toast-message"></span>
    </div>

    <!-- =========== JAVASCRIPT =========== -->
    <script src="database.js"></script>
    <script type_A="module">
      // Your provided database

      // --- ICON SVG Definitions ---
      const ICONS = {
        bookmark: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>`,
        bookmarkFilled: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>`,
        folder: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-zinc-500 dark:text-zinc-400"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`,
        chevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`,
      };

      const MONTH_ABBR = {
        January: "Jan",
        February: "Feb",
        March: "Mar",
        April: "Apr",
        May: "May",
        June: "Jun",
        July: "Jul",
        August: "Aug",
        September: "Sep",
        October: "Oct",
        November: "Nov",
        December: "Dec",
      };

      // --- Main Application ---
      document.addEventListener("DOMContentLoaded", () => {
        // --- State ---
        const state = {
          allQuestions: [],
          filteredQuestions: [],
          collections: {}, // { "collectionName": [id1, id2] }
          currentFilters: {
            subject: null,
            topic: null,
            year: null,
            month: null,
            university: null,
          },
          currentPage: "home",
          questionToBookmark: null,
          toastTimer: null,
        };

        // --- DOM Elements ---
        const dom = {
          pages: document.querySelectorAll(".page"),
          homePage: document.getElementById("page-home"),
          collectionsPage: document.getElementById("page-collections"),
          collectionDetailPage: document.getElementById(
            "page-collection-detail"
          ),
          questionListContainer: document.getElementById(
            "question-list-container"
          ),
          emptyState: document.getElementById("empty-state"),
          searchBar: document.getElementById("search-bar"),

          // Bottom Nav
          navButtons: document.querySelectorAll(".nav-btn"),

          // Filter Modal
          filterModal: document.getElementById("filter-modal"),
          openFilterBtn: document.getElementById("open-filter-btn"),
          closeFilterBtn: document.getElementById("close-filter-btn"),
          applyFilterBtn: document.getElementById("apply-filter-btn"),
          filterResetBtn: document.getElementById("filter-reset-btn"),
          filterSelects: document.querySelectorAll(".filter-select"),

          // Collections Page
          collectionList: document.getElementById("collection-list"),
          collectionsEmptyState: document.getElementById(
            "collections-empty-state"
          ),

          // Collection Detail Page
          backToCollectionsBtn: document.getElementById(
            "back-to-collections-btn"
          ),
          deleteCollectionBtn: document.getElementById("delete-collection-btn"),
          collectionDetailTitle: document.getElementById(
            "collection-detail-title"
          ),
          collectionQuestionList: document.getElementById(
            "collection-question-list"
          ),

          // Bookmark Modal
          bookmarkModal: document.getElementById("bookmark-modal"),
          closeBookmarkBtn: document.getElementById("close-bookmark-btn"),
          newCollectionName: document.getElementById("new-collection-name"),
          newCollectionError: document.getElementById("new-collection-error"),
          createCollectionBtn: document.getElementById("create-collection-btn"),
          existingCollectionsList: document.getElementById(
            "existing-collections-list"
          ),
          existingCollectionsEmpty: document.getElementById(
            "existing-collections-empty"
          ),

          // Toast
          toast: document.getElementById("toast"),
          toastMessage: document.getElementById("toast-message"),
        };

        // --- Initialization ---
        function init() {
          loadData();
          loadCollections();
          bindNavListeners();
          bindFilterModalListeners();
          bindBookmarkModalListeners();
          bindSearchListener();
          bindCollectionDetailListeners();

          populateFilterDropdowns();
          applyFiltersAndSearch();
          renderPage(state.currentPage);

          // Set dark mode based on system preference
          if (
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches
          ) {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        }

        // --- Data Loading ---
        function loadData() {
          state.allQuestions = DB;
          state.filteredQuestions = [...state.allQuestions];
        }

        function loadCollections() {
          state.collections =
            JSON.parse(localStorage.getItem("qbank_collections")) || {};
        }

        function saveCollections() {
          localStorage.setItem(
            "qbank_collections",
            JSON.stringify(state.collections)
          );
        }

        // --- Page Navigation ---
        function renderPage(pageId) {
          state.currentPage = pageId;
          dom.pages.forEach((page) => {
            page.classList.toggle("active", page.id === `page-${pageId}`);
          });

          // Update nav button active state
          dom.navButtons.forEach((btn) => {
            const isActive = btn.dataset.page === pageId;
            btn.classList.toggle("text-zinc-900", isActive);
            btn.classList.toggle("dark:text-zinc-50", isActive);
            btn.classList.toggle("text-zinc-500", !isActive);
            btn.classList.toggle("dark:text-zinc-400", !isActive);
          });

          // Specific page render functions
          if (pageId === "home") {
            applyFiltersAndSearch(); // Re-render question list
          } else if (pageId === "collections") {
            renderCollectionsPage();
          }
        }

        function bindNavListeners() {
          dom.navButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
              renderPage(btn.dataset.page);
            });
          });
        }

        // --- Question Rendering ---
        function renderQuestionList(questions, container) {
          container.innerHTML = ""; // Clear previous list

          if (questions.length === 0) {
            if (container === dom.questionListContainer) {
              dom.emptyState.classList.remove("hidden");
            } else {
              // Empty state for collection detail
              container.innerHTML = `
                            <div class="text-center text-zinc-500 dark:text-zinc-400 pt-16">
                                <h3 class="text-lg font-semibold">Collection is Empty</h3>
                                <p class="text-sm">You can remove questions from a collection here.</p>
                            </div>
                        `;
            }
            return;
          }

          if (container === dom.questionListContainer) {
            dom.emptyState.classList.add("hidden");
          }

          const fragment = document.createDocumentFragment();
          const allBookmarkedIds = Object.values(state.collections).flat();

          questions.forEach((q) => {
            const isBookmarked = allBookmarkedIds.includes(q.id);
            const card = document.createElement("div");
            card.className =
              "bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg shadow-sm p-4 relative";

            // --- NEW APPEARANCE LOGIC ---
            const groupedAppearancesSortable = {};
            const monthKeys = Object.keys(MONTH_ABBR); // Get keys once for indexOf

            q.appearances.forEach((a) => {
              const monthName = a.month;
              const monthAbbr = MONTH_ABBR[monthName] || monthName;
              const monthIndex = monthKeys.indexOf(monthName);
              const year = parseInt(a.year.toString());
              const dateStr = `${monthAbbr} '${year.toString().slice(-2)}`;

              if (!groupedAppearancesSortable[a.university]) {
                groupedAppearancesSortable[a.university] = [];
              }
              groupedAppearancesSortable[a.university].push({
                year,
                monthIndex,
                dateStr,
              });
            });

            const appearancesHTML = Object.entries(groupedAppearancesSortable)
              .map(([university, dates]) => {
                // Sort dates: descending year, then ascending month
                dates.sort((a, b) => {
                  if (a.year !== b.year) return b.year - a.year; // Newest year first
                  return a.monthIndex - b.monthIndex; // Earlier month first
                });

                const dateStrings = dates.map((d) => d.dateStr).join(", ");
                return `<span class="inline-block bg-zinc-100 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2.5 py-1 rounded-full text-xs font-medium">${university} ${dateStrings}</span>`;
              })
              .join("");
            // --- END NEW LOGIC ---

            card.innerHTML = `
                        <button class="bookmark-btn absolute top-3 right-3 p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-700 ${
                          isBookmarked
                            ? "text-zinc-900 dark:text-zinc-100"
                            : "text-zinc-400 dark:text-zinc-500"
                        }" data-id="${q.id}">
                            ${
                              isBookmarked
                                ? ICONS.bookmarkFilled
                                : ICONS.bookmark
                            }
                        </button>
                        <p class="text-base font-medium text-zinc-900 dark:text-white pr-10">${
                          q.text
                        }</p>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <span class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 px-2.5 py-1 rounded-full text-xs font-medium">${
                              q.subject
                            }</span>
                            <span class="inline-block bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-200 px-2.5 py-1 rounded-full text-xs font-medium">${
                              q.topic
                            }</span>
                        </div>
                        <div class="mt-3 flex flex-wrap gap-2">
                            ${appearancesHTML}
                        </div>
                    `;

            // Add listener to bookmark button
            card
              .querySelector(".bookmark-btn")
              .addEventListener("click", (e) => {
                e.stopPropagation();
                handleBookmarkClick(q.id);
              });

            fragment.appendChild(card);
          });

          container.appendChild(fragment);
        }

        // --- Search ---
        function bindSearchListener() {
          dom.searchBar.addEventListener("input", () => {
            applyFiltersAndSearch();
          });
        }

        // --- Filtering Logic (Dependent) ---
        function bindFilterModalListeners() {
          dom.openFilterBtn.addEventListener("click", () => {
            populateFilterDropdowns(); // Repopulate every time it opens
            dom.filterModal.classList.add("active");
          });
          dom.closeFilterBtn.addEventListener("click", () =>
            dom.filterModal.classList.remove("active")
          );
          dom.applyFilterBtn.addEventListener("click", () => {
            applyFiltersAndSearch();
            dom.filterModal.classList.remove("active");
          });
          dom.filterModal.addEventListener("click", (e) => {
            if (e.target === dom.filterModal) {
              dom.filterModal.classList.remove("active");
            }
          });
          dom.filterResetBtn.addEventListener("click", resetFilters);

          // This is the core of the dependent filters
          dom.filterSelects.forEach((select) => {
            select.addEventListener("change", () => {
              state.currentFilters[select.dataset.filter] =
                select.value || null;
              populateFilterDropdowns(); // Re-populate all dropdowns based on new selection
            });
          });
        }

        function resetFilters() {
          state.currentFilters = {
            subject: null,
            topic: null,
            year: null,
            month: null,
            university: null,
          };
          populateFilterDropdowns(); // Re-populate with all options
          applyFiltersAndSearch(); // Apply the reset
        }

        /**
         * Gets a list of questions filtered by all *except* the specified filter.
         * This is used to populate the dropdowns.
         * E.g., to populate "Topic", we filter by Subject, Year, Month, etc.
         */
        function getPotentiallyAvailableQuestions(filterToOmit) {
          let questions = state.allQuestions;

          for (const key in state.currentFilters) {
            if (key === filterToOmit || !state.currentFilters[key]) {
              continue;
            }

            const filterValue = state.currentFilters[key];

            if (key === "subject" || key === "topic") {
              questions = questions.filter((q) => q[key] === filterValue);
            } else if (
              key === "year" ||
              key === "month" ||
              key === "university"
            ) {
              // For appearances, we need .some()
              questions = questions.filter((q) =>
                q.appearances.some((a) => a[key].toString() === filterValue)
              );
            }
          }
          return questions;
        }

        function populateFilterDropdowns() {
          dom.filterSelects.forEach((select) => {
            const filterKey = select.dataset.filter;
            const availableQuestions =
              getPotentiallyAvailableQuestions(filterKey);

            let options;
            if (filterKey === "subject" || filterKey === "topic") {
              options = [
                ...new Set(availableQuestions.map((q) => q[filterKey])),
              ];
            } else {
              // For nested 'appearances'
              options = [
                ...new Set(
                  availableQuestions.flatMap((q) =>
                    q.appearances.map((a) => a[filterKey].toString())
                  )
                ),
              ];
            }

            options.sort();

            // Sort years in descending order
            if (filterKey === "year") {
              options.sort((a, b) => b - a);
            }

            renderSelectOptions(
              select,
              options,
              state.currentFilters[filterKey],
              `All ${filterKey}s`
            );
          });
        }

        function renderSelectOptions(
          selectEl,
          options,
          selectedValue,
          placeholder
        ) {
          const currentValue = selectedValue || "";
          selectEl.innerHTML = `<option value="">${placeholder}</option>`;
          options.forEach((option) => {
            const isSelected = option === currentValue;
            selectEl.innerHTML += `<option value="${option}" ${
              isSelected ? "selected" : ""
            }>${option}</option>`;
          });
        }

        function applyFiltersAndSearch() {
          // 1. Apply dropdown filters
          let questions = state.allQuestions;
          for (const key in state.currentFilters) {
            const filterValue = state.currentFilters[key];
            if (!filterValue) continue;

            if (key === "subject" || key === "topic") {
              questions = questions.filter((q) => q[key] === filterValue);
            } else {
              questions = questions.filter((q) =>
                q.appearances.some((a) => a[key].toString() === filterValue)
              );
            }
          }

          // 2. Apply search term
          const searchTerm = dom.searchBar.value.toLowerCase().trim();
          if (searchTerm) {
            questions = questions.filter(
              (q) =>
                q.text.toLowerCase().includes(searchTerm) ||
                q.subject.toLowerCase().includes(searchTerm) ||
                q.topic.toLowerCase().includes(searchTerm)
            );
          }

          state.filteredQuestions = questions;
          renderQuestionList(
            state.filteredQuestions,
            dom.questionListContainer
          );
        }

        // --- Bookmark & Collection Logic ---
        function bindBookmarkModalListeners() {
          dom.closeBookmarkBtn.addEventListener("click", () =>
            dom.bookmarkModal.classList.remove("active")
          );
          dom.bookmarkModal.addEventListener("click", (e) => {
            if (e.target === dom.bookmarkModal) {
              dom.bookmarkModal.classList.remove("active");
            }
          });

          dom.createCollectionBtn.addEventListener(
            "click",
            createAndAddCollection
          );
          dom.newCollectionName.addEventListener("keyup", (e) => {
            if (e.key === "Enter") createAndAddCollection();
          });
        }

        function handleBookmarkClick(questionId) {
          // Check if this question is already in *any* collection
          const allBookmarkedIds = Object.values(state.collections).flat();
          if (allBookmarkedIds.includes(questionId)) {
            // Simple "Un-bookmark" - remove from ALL collections
            // A more complex app might ask *which* collection to remove from
            for (const collectionName in state.collections) {
              state.collections[collectionName] = state.collections[
                collectionName
              ].filter((id) => id !== questionId);
              // Clean up empty collections
              if (state.collections[collectionName].length === 0) {
                delete state.collections[collectionName];
              }
            }
            saveCollections();
            showToast("Question removed from collections");
            // Re-render current list to update icon
            refreshCurrentList();
          } else {
            // Open "Add to Collection" modal
            state.questionToBookmark = questionId;
            renderExistingCollectionsList();
            dom.bookmarkModal.classList.add("active");
            //dom.newCollectionName.focus();
          }
        }

        function refreshCurrentList() {
          if (state.currentPage === "home") {
            renderQuestionList(
              state.filteredQuestions,
              dom.questionListContainer
            );
          } else if (state.currentPage === "collection-detail") {
            const collectionName = dom.collectionDetailTitle.textContent;
            if (state.collections[collectionName]) {
              renderCollectionDetailPage(collectionName);
            } else {
              // Collection was deleted
              renderPage("collections");
            }
          }
        }

        function renderExistingCollectionsList() {
          const collectionNames = Object.keys(state.collections);
          if (collectionNames.length === 0) {
            dom.existingCollectionsList.innerHTML = "";
            dom.existingCollectionsEmpty.classList.remove("hidden");
            return;
          }

          dom.existingCollectionsEmpty.classList.add("hidden");
          dom.existingCollectionsList.innerHTML = collectionNames
            .map(
              (name) => `
                    <button class="add-to-collection-btn w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-700" data-name="${name}">
                        ${ICONS.folder}
                        <span class="font-medium">${name}</span>
                    </button>
                `
            )
            .join("");

          // Add listeners to these new buttons
          document.querySelectorAll(".add-to-collection-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              addQuestionToCollection(btn.dataset.name);
            });
          });
        }

        function createAndAddCollection() {
          const name = dom.newCollectionName.value.trim();
          dom.newCollectionError.classList.add("hidden");

          if (!name) {
            dom.newCollectionError.textContent = "Please enter a name.";
            dom.newCollectionError.classList.remove("hidden");
            return;
          }
          if (state.collections[name]) {
            dom.newCollectionError.textContent =
              "A collection with this name already exists.";
            dom.newCollectionError.classList.remove("hidden");
            return;
          }

          state.collections[name] = [];
          addQuestionToCollection(name);
          dom.newCollectionName.value = "";
        }

        function addQuestionToCollection(name) {
          if (!state.collections[name].includes(state.questionToBookmark)) {
            state.collections[name].push(state.questionToBookmark);
            saveCollections();
            showToast(`Saved to "${name}"`);
          } else {
            showToast(`Already in "${name}"`);
          }
          dom.bookmarkModal.classList.remove("active");
          state.questionToBookmark = null;
          // Re-render home list to update icon
          renderQuestionList(
            state.filteredQuestions,
            dom.questionListContainer
          );
        }

        // --- Collections Page ---
        function renderCollectionsPage() {
          const collectionNames = Object.keys(state.collections);
          if (collectionNames.length === 0) {
            dom.collectionList.innerHTML = "";
            dom.collectionsEmptyState.classList.remove("hidden");
            return;
          }

          dom.collectionsEmptyState.classList.add("hidden");
          dom.collectionList.innerHTML = collectionNames
            .map((name) => {
              const count = state.collections[name].length;
              return `
                    <button class="view-collection-btn w-full flex justify-between items-center bg-white dark:bg-zinc-800 p-4 rounded-lg border border-zinc-200 dark:border-zinc-700 shadow-sm hover:bg-zinc-50 dark:hover:bg-zinc-700" data-name="${name}">
                        <div class="flex items-center gap-3">
                            ${ICONS.folder}
                            <div>
                                <h3 class="font-semibold text-left">${name}</h3>
                                <p class="text-sm text-zinc-500 dark:text-zinc-400">${count} question${
                count !== 1 ? "s" : ""
              }</p>
                            </div>
                        </div>
                        ${ICONS.chevronRight}
                    </button>
                `;
            })
            .join("");

          // Add listeners
          document.querySelectorAll(".view-collection-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              renderCollectionDetailPage(btn.dataset.name);
              renderPage("collection-detail");
            });
          });
        }

        // --- Collection Detail Page ---
        function bindCollectionDetailListeners() {
          dom.backToCollectionsBtn.addEventListener("click", () => {
            renderPage("collections");
          });
          dom.deleteCollectionBtn.addEventListener("click", () => {
            const collectionName = dom.collectionDetailTitle.textContent;
            // Using a simple prompt as a custom modal is a lot of extra code
            // User requested no 'alert', 'confirm'. This is a tricky spot.
            // Let's just delete it directly, as it's an internal-facing tool.
            // A better app would have a custom "Are you sure?" modal.
            // For now, let's just do it.
            if (collectionName && state.collections[collectionName]) {
              delete state.collections[collectionName];
              saveCollections();
              showToast(`Collection "${collectionName}" deleted`);
              renderPage("collections");
            }
          });
        }

        function renderCollectionDetailPage(collectionName) {
          dom.collectionDetailTitle.textContent = collectionName;
          const questionIds = state.collections[collectionName] || [];
          const questions = state.allQuestions.filter((q) =>
            questionIds.includes(q.id)
          );

          // Re-use the renderQuestionList function
          renderQuestionList(questions, dom.collectionQuestionList);
        }

        // --- Toast ---
        function showToast(message) {
          if (state.toastTimer) {
            clearTimeout(state.toastTimer);
          }
          dom.toastMessage.textContent = message;
          dom.toast.classList.add("active");

          state.toastTimer = setTimeout(() => {
            dom.toast.classList.remove("active");
            state.toastTimer = null;
          }, 2000);
        }

        // --- Start the app ---
        init();
      });
    </script>
  </body>
</html>
